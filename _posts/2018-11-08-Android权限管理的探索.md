---
layout:     post
title:      Androidæƒé™ç®¡ç†çš„æ¢ç´¢
subtitle:   Androidæƒé™
date:       2018-11-08
author:     YANKEBIN
catalog: true
tags:
     - Android
     - Androidæƒé™
     - Javassist
     - gradle plugin
---

# å‰è¨€
æ„Ÿè§‰å·²ç»å¾ˆä¹…æ²¡æœ‰å†™åšå®¢äº†ï¼Œ5æœˆä»½ä¹‹åä¸€ç›´åœ¨å­¦ä¹ kotlin,è¾¹å­¦è¾¹ç”¨ï¼Œç®—æ˜¯å…¥é—¨äº†å§ï¼›ç„¶ååˆçªç„¶å¯¹çƒ­æ›´æ–°æŠ€æœ¯å¾ˆæœ‰å…´è¶£ï¼Œåˆå»å­¦ä¹ äº†ä¸€æ®µæ—¶é—´ï¼Œæ— å¥ˆæ¯•ç«Ÿæˆ‘æ˜¯å‡¡äººä¸€ä¸ªï¼Œåªèƒ½è†œæ‹œé‚£äº›å¤§ç¥å•Šï¼›æœ€è¿‘åˆåœ¨éšå¤§æµï¼Œå¼€å§‹å¥½å¥‡AIé¢†åŸŸï¼Œå›½å†…èµ„æ–™å¤ªå°‘ï¼Œå¾ˆå¤šè¿˜æ”¶è´¹ï¼Œå¥½ä¸å®¹æ˜“æ‰¾åˆ°ä¸ªå›½å¤–å…è´¹çš„ï¼Œå¯æƒœè¿™è‹±æ–‡èƒ½åŠ›å¤ªå¼±ï¼Œå®åœ¨æ˜¯ç´¯æå•Šã€‚

å°±å½“æˆ‘æ­£åœ¨æµ‘æµ‘å™©å™©ä¹‹æ—¶ï¼Œçªå’Œæœ‹å‹è®¨è®ºèµ·çš„Androidæƒé™ç”³è¯·çš„é—®é¢˜ï¼Œæœ€åæˆ‘ä»¬å¾—å‡ºè¿™æ ·ä¸€ä¸ªç»“è®ºï¼šç›®å‰å„ä¸ªæ¯”è¾ƒæµè¡Œçš„æƒé™ç®¡ç†å¼€æºåº“éƒ½æœ‰ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„ä½¿ç”¨æ­¥éª¤ã€‚

è™½è¯´æœ‰äº›å¼€æºåº“ä¾é æ³¨è§£å’ŒAPTæŠ€æœ¯æ¥ç®€åŒ–äº†æƒé™ç”³è¯·çš„æµç¨‹ï¼Œä½†æˆ‘æ„Ÿè§‰è¿˜æ˜¯ä¸å¤Ÿç®€å•ï¼Œæ¯”å¦‚githubä¸Šstaræ¯”è¾ƒå¤šçš„ä¸€ä¸ªå¼€æºåº“

>[PermissionsDispatcher](https://github.com/permissions-dispatcher/PermissionsDispatcher)

starè¶³æœ‰8000å¾€ä¸Šä¹‹å¤šï¼Œå¯è§Androidæƒé™ç”³è¯·çš„é‡è¦æ€§ä¸ä½¿ç”¨çš„é¢‘ç¹æ€§ã€‚å¯å°±è¿™ä¹ˆä¸ªè¦é¢‘ç¹ä½¿ç”¨çš„ä¸œè¥¿ï¼Œå¾ˆå¤šAndroidç¨‹åºå‘˜éƒ½è¢«å…¶å¤æ‚çš„æµç¨‹æ‰€å›°æ‰°ï¼Œä¸ºäº†ç”³è¯·åˆ°æƒé™ï¼Œä¸å¾—ä¸åœ¨è‡ªå·±çš„ä»£ç é‡ŒåŠ ä¸Šä¸€äº›çœ‹ä¼¼æ¯«æ— å…³è”çš„ä»£ç é€»è¾‘ï¼Œæ¯”å¦‚ï¼ŒActivityæˆ–Fragmentå¿…éœ€é‡å†™çš„ä¸€ä¸ªæ–¹æ³•

	@Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
    }
  
å³ä½¿ä½ ä½¿ç”¨äº†ä¸€äº›å¼€æºåº“ï¼Œæ¯”å¦‚PermissionsDispatcherï¼Œä½ ä¹Ÿè¦é‡è½½è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”åœ¨é‡Œé¢åŠ ä¸Šç±»ä¼¼xxx.onRequestPermissionsResultè¿™æ ·çš„ä»£ç ï¼Œå‘Šè¯‰ä½ å¼•ç”¨çš„å¼€æºåº“ï¼ŒæŸäº›æƒé™å›è°ƒäº†ï¼Œä½ å¼•ç”¨çš„å¼€æºåº“æ‰èƒ½ç»§ç»­æ‰§è¡Œå›è°ƒã€‚

é‚£ä¹ˆï¼Œå°±æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è®©æˆ‘ä»¬åªæ˜¯ç”¨æ³¨è§£ï¼Œæ— éœ€æ’å…¥å…¶ä»–é€»è¾‘ä»£ç å³å¯å®ç°æƒé™ç”³è¯·äº†å—ï¼Ÿå½“ç„¶æœ‰ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä¸ç„¶æˆ‘ä»Šå¤©ä¹Ÿä¸ä¼šæ¥å†™è¿™ç¯‡æ–‡ç« äº†ï¼ˆæœºæ™ºå¦‚æˆ‘):)ã€‚å¹¶ä¸”æˆ‘å¯ä»¥è´Ÿè´£ä»»çš„å‘Šè¯‰å¤§å®¶ï¼Œæ–¹æ³•è‚¯å®šä¸æ­¢æˆ‘è¿™ä¸€ç§ï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥é¡ºç€æˆ‘ä»Šå¤©è¿™ç¯‡æ–‡ç« çš„æ€è·¯ï¼Œå»å°è¯•ä¸€ä¸‹å…¶ä»–æ–¹å¼ï¼Œè¯´ä¸å®šç»“æœä¼šå‡ºä¹ä½ çš„æ„æ–™å“¦ã€‚

å…ˆç»™å‡ºé¡¹ç›®çš„åœ°å€

>[SimplePermission](https://github.com/ykbjson/SimplePermission)

# ä¸€ã€åŸç†ç®€ä»‹

## 1.1 æŠ€æœ¯æ‰«ç›²

ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„è¿™ä¸ªå¼€æºåº“å‘¢ï¼Œä¹Ÿç®—æ˜¯æˆ‘æœ€è¿‘ç ”ç©¶çƒ­æ›´æ–°æŠ€æœ¯å¾—åˆ°å¯å‘è€Œå®ç°çš„ï¼ŒåŸç†å’ŒæŠ€æœ¯å…¶å®éƒ½éå¸¸ç®€å•ï¼Œåªæ¶‰åŠåˆ°ä¸¤ä¸ªæ–¹é¢ï¼š

1. gradle transform api

2. javassist

ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹é¢çš„æŠ€æœ¯è¯´åˆ°åº•ï¼Œå°±æ˜¯ä¸ºäº†è·å–åˆ°ä¸€äº›æŒ‡å®šçš„classæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨classæ–‡ä»¶è¢«æ‰“åŒ…æˆdexæ–‡ä»¶ä¹‹å‰ï¼Œå¾€classæ–‡ä»¶é‡Œæ’å…¥ä»£ç ã€‚

å…³äºjavassistå’Œgradle transform apiçš„æŠ€æœ¯ä¸»è¦å‚è€ƒèµ„æ–™å¦‚ä¸‹ï¼š

> [Javaå­¦ä¹ ä¹‹javassist](https://www.cnblogs.com/sunfie/p/5154246.html)

> [è‡ªå®šä¹‰Gradleæ’ä»¶](https://www.jianshu.com/p/417589a561da)

> [Plugin Transform Javassistæ“ä½œClassæ–‡ä»¶](https://blog.csdn.net/yulong0809/article/details/77752098?locationNum=9&fps=1)

> [Androidä¸­ä½¿ç”¨Javassist](https://blog.csdn.net/Deemons/article/details/78473874)


å°¤å…¶æ˜¯ç¬¬å››ä¸ªæ–‡ç« é“¾æ¥æœ«å°¾æœ‰å…¶demoçš„githubåœ°å€ï¼Œå¾ˆå¤šjavassistçš„ç”¨æ³•éƒ½å¯ä»¥åœ¨demoé‡Œæ‰¾åˆ°ï¼Œå¤§å®¶éœ€è¦æ…¢æ…¢ç ”ç©¶ã€‚æ¯”å¦‚ï¼Œæˆ‘æœ€å¼€å§‹æƒ³å®ç°è¿™ä¸ªå¼€æºåº“çš„æ—¶å€™ï¼Œå°±é‡åˆ°äº†æ— æ³•æ’å…¥æ¶‰åŠandroid apiçš„ä»£ç ï¼Œå½“æ—¶æ„Ÿè§‰å·²ç»æ²¡æœ‰å¸Œæœ›äº†ï¼Œéš”äº†ä¸€ä¸¤å¤©ï¼Œæˆ‘è¿˜æ˜¯ä¸æƒ³æ”¾å¼ƒï¼Œå†æ¬¡ä¸€é˜µgoogleä¹‹åï¼Œæ€»ç®—æ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œæ‰€ä»¥çœŸçš„éå¸¸æ„Ÿè°¢è¿™äº›å¤§ç¥ä»¬å•Šã€‚

ä¸Šé¢çš„å‚è€ƒä¸æ˜¯å¿…é¡»çš„ï¼Œå¤§å®¶å¯ä»¥å…ˆå¼€å§‹å°è¯•ç€è·Ÿç€ç¬¬äºŒä¸ªé“¾æ¥é‡Œå†…å®¹å»å†™ä¸€ä¸ªè‡ªå·±çš„gradle pluginæ’ä»¶ï¼Œåœ¨å®ç°çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ï¼Œåœ¨å›æ¥å‚è€ƒå…¶ä»–é“¾æ¥é‡Œçš„çŸ¥è¯†ï¼Œå¾ªåºæ¸è¿›ï¼Œè‚¯å®šèƒ½æœ‰æ‰€å¢ç›Šçš„ã€‚


å‰é¢è¯´äº†ï¼Œç›®å‰å¤§å¤šæ•°æƒé™åº“éƒ½æœ‰ä¸€ä¸ªä¸å¤ªé¡ºæ‰‹çš„åœ°æ–¹ï¼ˆä¸æ˜¯ç¼ºç‚¹å“ˆï¼‰ï¼Œå°±æ˜¯è¦ç¨‹åºå‘˜æ‰‹åŠ¨æ·»åŠ ä¸€äº›ä»£ç ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ï¼Œé‚£ä¹ˆï¼Œå¦‚æœæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è‡ªåŠ¨å¾€æˆ‘ä»¬éœ€è¦æƒé™çš„ç±»æˆ–æ–¹æ³•é‡ŒåŠ ä¸Šç”³è¯·æƒé™çš„ä»£ç ï¼Œå²‚ä¸ç¾å“‰ï¼Ÿåˆšæ‰å·²ç»è¯´è¿‡äº†javassistå’Œgradle transform apiæŠ€æœ¯çš„ä½œç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ä»–ä»¬æ¥å®Œæˆå¾€ç±»æˆ–æ–¹æ³•é‡Œæ’å…¥æƒé™ç”³è¯·çš„ä»£ç å•¦ã€‚

## 1.2é—®é¢˜&è§£å†³åŠæ³•
ç°åœ¨æˆ‘ä»¬ä»…ä»…æ˜¯çŸ¥é“äº†å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä¿®æ”¹classæ–‡ä»¶ï¼Œå¾€æŸäº›ç‰¹å®šçš„classæ–‡ä»¶é‡Œæ’å…¥ä»£ç ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±è‡³å°‘è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. å¦‚ä½•æ‰¾å‡ºå“ªäº›classæ–‡ä»¶éœ€è¦æ’å…¥ä»£ç ?

2. å¦‚ä½•æ‰¾å‡ºå“ªäº›æ–¹æ³•éœ€è¦ç”³è¯·æƒé™ï¼Ÿéœ€è¦ç”³è¯·å“ªäº›æƒé™ï¼Ÿ
 
3. éœ€è¦ç”³è¯·æƒé™çš„æ–¹æ³•ç”³è¯·æƒé™æˆåŠŸåéœ€è¦å¦‚ä½•å¤„ç†ï¼Ÿ

4. permissionæƒé™ç”³è¯·åº“é‡‡ç”¨çš„æ˜¯å›è°ƒçš„å½¢å¼æ¥é€šçŸ¥æƒé™ç”³è¯·ç»“æœï¼Œæˆ‘ä»¬å¯å¦åœ¨è¯¥classæ–‡ä»¶ä»»ä½•åœ°æ–¹æ’å…¥æƒé™ç”³è¯·çš„ä»£ç ï¼Ÿ

å¯¹äºç¬¬1ä¸ªå’Œç¬¬2ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ³¨è§£å¾ˆå¥½çš„å»è§£å†³ï¼Œç¼–è¯‘æ—¶æ³¨è§£å³å¯ï¼Œå¤§å®¶ä¸è¦åœ¨æ„æˆ‘çš„simplepermission_anoé‡Œçš„æ³¨è§£æ˜¯è¿è¡Œæ—¶çš„ï¼Œä¹ æƒ¯äº†ï¼Œæ²¡æ”¹è¿‡æ¥ğŸ™ƒã€‚

è‡³äºç¬¬3ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ˜¯éœ€è¦ç¢ç£¨ä¸€ä¸‹çš„ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æŸä¸ªæ–¹æ³•è¦ç”³è¯·æƒé™æ€»æ˜¯æ„å‘³ç€æˆ‘ä»¬çš„æ–¹æ³•é‡Œé¢çš„ä¸€äº›æ“ä½œéœ€è¦ä¾èµ–äºæŸäº›æƒé™ï¼Œå¹¶ä¸”æœ‰äº›æ˜¯å¿…é¡»è¦å…ˆå¾—åˆ°æƒé™åæ‰å¯ä»¥æ‰§è¡Œçš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸èƒ½å•çº¯çš„åœ¨è¿™æ–¹æ³•é‡Œæ’å…¥ç”³è¯·æƒé™çš„ä»£ç ï¼Œè¿˜è¦å¹²é¢„è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æƒé™ç”³è¯·æµç¨‹å¹¶ä¸æ˜¯é˜»å¡å¼çš„ï¼Œè€Œæ˜¯å¼‚æ­¥å›è°ƒå¼çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ²¡åŠæ³•åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨å»å¹²é¢„å…¶é€»è¾‘äº†ã€‚é‚£ä¹ˆæ˜¯å¦å°±æ— è®¡å¯æ–½äº†å‘¢ï¼Ÿå…¶å®ä¸ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæƒé™ç”³è¯·çš„ä»£ç æ’å…¥åˆ°è¯¥æ–¹æ³•çš„æœ€å‰éƒ¨åˆ†ï¼Œæ ¹æ®æ–¹æ³•ä¸Šçš„æ³¨è§£é‡Œçš„ä¸€ä¸ªå€¼æ¥åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦éœ€è¦ç­‰åˆ°æƒé™å›è°ƒæˆåŠŸäº†åœ¨æ‰§è¡Œåç»­é€»è¾‘ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥**åœ¨æƒé™ç”³è¯·å›è°ƒæˆåŠŸçš„åœ°æ–¹æ’å…¥è°ƒç”¨åˆšæ‰ç”³è¯·æƒé™çš„é‚£ä¸ªæ–¹æ³•çš„ä»£ç **ï¼Œé‡æ–°æ‰§è¡Œå…¶å†…éƒ¨é€»è¾‘ï¼ˆå› ä¸ºæˆ‘ä»¬é‡æ–°è°ƒç”¨äº†é‚£ä¸ªæ–¹æ³•ï¼‰ä¸å°±å¯ä»¥äº†å—ï¼Ÿä¸è¿‡è¿™åˆç‰µæ¶‰åˆ°å¦ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªæ— å‚æ— è¿”å›å€¼çš„æ–¹æ³•ï¼Œé‚£å°±éå¸¸ç®€å•å•¦ï¼Œä½†æ˜¯å¦‚æœè¯¥æ–¹æ³•æœ‰å‚æ•°è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬åœ¨æƒé™ç”³è¯·å›è°ƒæˆåŠŸçš„åœ°æ–¹å†æ¬¡è°ƒç”¨è¯¥æ–¹æ³•å°±æ— æ³•ç»§ç»­å†™å•¦ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å‚æ•°å•Šï¼äºæ˜¯æˆ‘åˆæƒ³åˆ°äº†ä¸€ä¸ªåŠæ³•ï¼Œåœ¨ç”³è¯·æƒé™çš„ç±»é‡ŒåŠ å…¥ä¸€ä¸ªå…¨å±€å˜é‡ï¼ˆä¸å¸¦æ³›å‹çš„Mapï¼‰ï¼Œå½“æŸä¸ªç”³è¯·æƒé™çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å·²ç»è¢«æˆ‘ä»¬æ’å…¥äº†åˆ¤æ–­åº”ç”¨ç¨‹åºæ˜¯å¦æ‹¥æœ‰å…¶æ³¨è§£é‡ŒåŒ…å«çš„æƒé™çš„ä»£ç äº†ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå·²ç»æ‹¥æœ‰äº†é‚£äº›æƒé™ï¼Œé‚£æˆ‘ä»¬ä¾¿ä¸å†å¹²é¢„å…¶åç»­é€»è¾‘ï¼›å¦‚æœåº”ç”¨ç¨‹åºè¿˜æœªæ‹¥æœ‰é‚£äº›æƒé™ï¼Œåˆ™ç”¨ä¸€ä¸ªä¸å¸¦æ³›å‹çš„ListæŠŠè¯¥æ–¹æ³•çš„å‚æ•°æŒ¨ä¸ªå­˜å‚¨èµ·æ¥ï¼Œç„¶åæŠŠè¿™ä¸ªListæ”¾åˆ°å…¨å±€çš„é‚£ä¸ªä¸å¸¦æ³›å‹çš„Mapé‡Œï¼Œå½“ç„¶ï¼Œæ”¾åˆ°mapé‡Œæ—¶çš„é‚£ä¸ªkeyï¼Œå°±æ˜¯æ–¹æ³•çš„æ³¨è§£é‡Œçš„ä¸€ä¸ªå”¯ä¸€å€¼ã€‚ç„¶åï¼Œå’Œåˆšæ‰çš„é€»è¾‘ä¸€æ ·ï¼Œåœ¨æƒé™ç”³è¯·å›è°ƒæˆåŠŸçš„åœ°æ–¹ï¼Œæ ¹æ®å›è°ƒé‡Œçš„é‚£ä¸ªå”¯ä¸€å€¼ä½œä¸ºkeyï¼Œä»mapé‡Œå–å‡ºæ¬¡æ–¹æ³•çš„å‚æ•°ï¼Œæ’å…¥å†æ¬¡è°ƒç”¨æ­¤æ–¹æ³•çš„ä»£ç ï¼Œé—®é¢˜ä¸å°±è§£å†³äº†å—ğŸ˜ã€‚ä¸è¿‡ï¼Œå¯¹äºå¸¦æœ‰è¿”å›å€¼çš„æ–¹æ³•ï¼Œç›®å‰æˆ‘ä¹Ÿæ²¡æœ‰æƒ³åˆ°æœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•å»è§£å†³ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ï¼Œä¸€å®šæ˜¯å¯ä»¥è§£å†³çš„,æˆ‘ä¼šå¥½å¥½ç¢ç£¨ç¢ç£¨çš„ã€‚


é‡‘æ— èµ¤è¶³ï¼Œäººæ— å®Œäººï¼Œå¯¹äºæœ€åä¸€ä¸ªé—®é¢˜ï¼Œç”±äºæœ¬äººèƒ½åŠ›æœ‰é™å’Œjavassistçš„ä¸€äº›é™åˆ¶ï¼Œç›®å‰æœ¬åº“æ— æ³•åœ¨å†…éƒ¨ç±»é‡Œä½¿ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„é—æ†¾ï¼Œå¸Œæœ›éšç€æ—¶é—´çš„æ¨ç§»ï¼Œjavassistèƒ½å¤Ÿæ”¯æŒæ’å…¥å†…éƒ¨ç±»å§ã€‚


# äºŒã€æ²¡æœ‰ä»£ç çš„ä»£ç å®ç°

å…¶å®ä»£ç å®ç°éƒ¨åˆ†çœŸæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé¡¹ç›®æˆ‘éƒ½æ”¾åˆ°äº†githubï¼Œå¤§å®¶å¯ä»¥å…ˆç›´æ¥å»çœ‹æœ¬å¼€æºåº“çš„READMEï¼Œå…ˆäº†è§£permissionæƒé™ç”³è¯·åº“çš„åŸºæœ¬ç”¨æ³•ï¼Œåœ¨å»çœ‹simplepermissionpluginçš„æºç ï¼Œå°±ä¼šå¾ˆå¿«æ˜ç™½æ˜¯æ€ä¹ˆå®ç°çš„å•¦ã€‚è‡³äºsimplepermission_anoåº“ï¼Œä½ å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œé‡Œé¢å°±ä¸¤ä¸ªæ³¨è§£è€Œå·²ã€‚simplepermissionpluginæºç æˆ‘æ³¨é‡Šçš„éå¸¸æ¸…æ¥šï¼Œé‡Œé¢æ‰€æœ‰æ¶‰åŠåˆ°çš„æŠ€æœ¯ï¼Œå‰é¢ç»™çš„é‚£å‡ ç¯‡å‚è€ƒæ–‡ç« é‡Œéƒ½åªä¼šå¤šä¸ä¼šå°‘ã€‚

åœ¨è¿™é‡Œå‘¢ï¼Œæˆ‘ä¹Ÿä¸ä¼šè´´å¾ˆå¤šä»£ç å•¦ï¼Œæˆ‘åªæ˜¯æƒ³é€šè¿‡ä¸€ç‚¹ä»£ç å¯¹æ¯”ï¼Œè®©å¤§å®¶çœ‹çœ‹ï¼Œæ­£å¸¸ä½¿ç”¨permissionæƒé™åº“å’Œç”¨gradleæ’ä»¶&æ³¨è§£æ–¹å¼ä½¿ç”¨permissionæƒé™åº“çš„åŒºåˆ«ã€‚

æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨permissionæƒé™åº“çš„ä»£ç å¦‚ä¸‹

	public class MainActivity extends AppCompatActivity implements View.OnClickListener
		private TextView mTextMessage;
		protected void onCreate(Bundle savedInstanceState) {
	        super.onCreate(savedInstanceState);
	        setContentView(R.layout.activity_main);
	        mTextMessage = (TextView) findViewById(R.id.message);
	
	        mTextMessage.setOnClickListener(this);
		}
		 /**
    	  * æ­¤æ–¹æ³•éœ€è¦ä¸€ä¸ª Manifest.permission.READ_CONTACTSæƒé™
     	  *
     	  * @param text
     	  */
	    private void setText(final String text) {
	        PermissionsManager.getInstance().requestPermissionsIfNecessaryForResult(10010, this,
            new String[]{Manifest.permission.READ_CONTACTS}, new PermissionsRequestCallback() {
                @Override
                public void onGranted(int requestCode, String permission) {
                    
                }

                @Override
                public void onDenied(int requestCode, String permission) {

                }

                @Override
                public void onDeniedForever(int requestCode, String permission) {

                }

                @Override
                public void onFailure(int requestCode, String[] deniedPermissions) {

                }

                @Override
                public void onSuccess(int requestCode) {
                    mTextMessage.setText(text);
                }
            });
	    }
	
	    @Override
	    public void onClick(View v) {
	        setText("å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ");
	    }
	    
	    @Override
	    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
	        PermissionsManager.getInstance().notifyPermissionsChange(permissions,grantResults);
	        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
	    }
	}


ç”¨gradleæ’ä»¶&æ³¨è§£æ–¹å¼ä½¿ç”¨permissionæƒé™åº“çš„ä»£ç å¦‚ä¸‹

	@PermissionNotify
	public class MainActivity extends AppCompatActivity implements View.OnClickListener
		private TextView mTextMessage;
		protected void onCreate(Bundle savedInstanceState) {
	        super.onCreate(savedInstanceState);
	        setContentView(R.layout.activity_main);
	        mTextMessage = (TextView) findViewById(R.id.message);
	
	        mTextMessage.setOnClickListener(this);
		}
		
		 /**
	     * æ­¤æ–¹æ³•éœ€è¦ä¸€ä¸ª Manifest.permission.READ_CONTACTSæƒé™
	     *
	     * @param text
	     */
	    @PermissionRequest(
	            requestCode = 10010,
	            requestPermissions =
	             {Manifest.permission.READ_CONTACTS}
	            , needReCall = true
	    )
	    private void setText(final String text) {
	        mTextMessage.setText(text);
	    }
	
	    @Override
	    public void onClick(View v) {
	        setText("å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ");
	    }
	}
	
æœ€ååœ¨app moduleçš„build/intermediates/transforms/SimplePermissionTransform/debug(æˆ–release)/24(å¯èƒ½æ˜¯å…¶ä»–æ•°å­—)/åŒ…å æ–‡ä»¶å¤¹ä¸‹å¯ä»¥çœ‹åˆ°åŠ ä¸Šäº†æ³¨è§£çš„ç±»çš„å®é™…ç¼–è¯‘ç»“æœï¼Œç±»ä¼¼å¦‚ä¸‹

	@PermissionNotify
	public class MainActivity extends AppCompatActivity implements OnClickListener, PermissionsRequestCallback {
	    private TextView mTextMessage;
	   	 private final Map requestPermissionMethodParams = new HashMap();
	
	    public MainActivity() {
	    }
	
	    protected void onCreate(Bundle savedInstanceState) {
	        super.onCreate(savedInstanceState);
	        this.setContentView(2131361818);
	       
	        this.mTextMessage.setOnClickListener(this);
	    }
	
	    @PermissionRequest(
	        requestCode = 10010,
	        requestPermissions = {"android.permission.ACCESS_FINE_LOCATION", "android.permission.ACCESS_COARSE_LOCATION", "android.permission.READ_CONTACTS"},
	        needReCall = true
	    )
	    private void setText(String text) {
	        String[] var2 = new String[]{"android.permission.ACCESS_FINE_LOCATION", "android.permission.ACCESS_COARSE_LOCATION", "android.permission.READ_CONTACTS"};
	        boolean var3 = PermissionsManager.getInstance().hasAllPermissions(this, var2);
	        if (!var3) {
	            ArrayList var4 = new ArrayList();
	            var4.add(text);
	            this.requestPermissionMethodParams.put(10010, var4);
	            PermissionsManager.getInstance().requestPermissionsIfNecessaryForResult(10010, this, var2, this);
	        } else {
	            this.mTextMessage.setText(text);
	        }
	    }
	
	    public void onClick(View v) {
	        this.setText("å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ");
	    }
	
	    public void onGranted(int var1, String var2) {
	    }
	
	    public void onDenied(int var1, String var2) {
	    }
	
	    public void onDeniedForever(int var1, String var2) {
	    }
	
	    public void onFailure(int var1, String[] var2) {
	    }
	
	    public void onSuccess(int var1) {
	        Object var2 = this.requestPermissionMethodParams.get(var1);
	        if (var1 == 10010) {
	            this.setText((String)((List)var2).get(0));
	        }
	    }
	
	    public void onRequestPermissionsResult(int var1, String[] var2, int[] var3) {
	        PermissionsManager.getInstance().notifyPermissionsChange(var2, var3);
	        super.onRequestPermissionsResult(var1, var2, var3);
	    }
	}



æˆ‘æƒ³ï¼Œé€šè¿‡è¿™ä¸ªå¯¹æ¯”ï¼Œå¤§å®¶è‚¯å®šèƒ½çœ‹å‡ºæ¥åŒºåˆ«åœ¨å“ªé‡Œå§ã€‚ç®€åŒ–äº†å¾ˆå¤šé€»è¾‘ä»£ç ï¼Œå½“ç„¶ä¹Ÿå¢åŠ äº†ä¸€äº›ä»£ç ï¼Œä¸è¿‡ï¼Œä¸¤ç§æ–¹å¼å­°ä¼˜å­°åŠ£ï¼Œå¤§å®¶ä¸€çœ¼ä¾¿çŸ¥ã€‚


# ä¸‰ã€ç»“è¯­
æœ¬åº“çœ‹ä¸Šå»ç”¨èµ·æ¥ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†æ˜¯å…·ä½“çš„ç»†èŠ‚å®ç°ä¸Šå´å¹¶ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ï¼Œç”±äºä¸ªäººèƒ½åŠ›å’Œä¸€äº›æŠ€æœ¯çš„é™åˆ¶ï¼Œæˆ‘è¿˜é¢ä¸´å¾ˆå¤šé—®é¢˜ã€‚æ¯”å¦‚æœ¬å¼€æºåº“åªæ”¯æŒåœ¨Activityæˆ–Fragmenté‡Œä½¿ç”¨ï¼›åˆæ¯”å¦‚è¿™ä¸ªå¼€æºåº“ä¸èƒ½æ”¾åˆ°å†…éƒ¨ç±»é‡Œç­‰ç­‰ç­‰ç­‰ï¼Œå…·ä½“çš„å¯æŸ¥çœ‹æœ¬å¼€æºåº“READMEçš„ç¬¬4æ¡ï¼Œè¿™äº›éƒ½æ˜¯ç›®å‰æˆ‘æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œå¸Œæœ›èƒ½æœ‰å¤§ç¥æç‚¹ä¸€äºŒï¼Œæ„Ÿæ¿€ä¸å°½ã€‚

è¿™ä¸ªåº“å…¶å®æ›´æ·±ä¸€ç‚¹çš„æ„ä¹‰ï¼Œå°±æ˜¯åœ¨è¿™é‡ŒæŠ›ç –å¼•ç‰ï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤ŸæŒ–æ˜å‡ºæ›´å¥½çš„Androidæƒé™ç®¡ç†å¼€æºåº“ï¼Œé€ ç¦åƒåƒä¸‡ä¸‡çš„Androidç¨‹åºå‘˜å•Šã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œè¿™ä¸ªåº“æƒé™ç”³è¯·çš„éƒ¨åˆ†æ˜¯simplepermissioné‡Œçš„ä»£ç å®ç°çš„ï¼Œæˆ‘æ‰€å¼€å‘çš„æ’ä»¶å°±å¿…é¡»å—åˆ°simplepermissionè¿™ä¸ªåº“çš„ä¸€äº›é™åˆ¶ï¼Œä½†æ˜¯æ€è·¯å´å¯ä»¥ä¸å—é™åˆ¶ï¼Œè¯´ä¸å®šå¤§å®¶æ‰‹é‡Œæœ‰éå¸¸å¥½çš„å¼€æºåœˆå­çœ‹ä¸åˆ°çš„Adroidæƒé™ç”³è¯·åº“ï¼Œå¦‚æœå¤§å®¶æŠŠæ‰‹é‡Œçš„Adroidæƒé™ç”³è¯·åº“é¡ºç€æˆ‘è¿™ä¸ªæ€è·¯ä¹Ÿå†™ä¸ªgradleæ’ä»¶ï¼Œè®©Androidæƒé™ç”³è¯·çš„ä½¿ç”¨æ›´åŠ çš„ç®€ä¾¿ï¼ŒåŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼Œå²‚ä¸æ˜¯é€ ç¦å¹¿å¤§çš„Androidç¨‹åºçŒ¿å•Šï¼Œæƒ³æƒ³è¿˜æœ‰ç‚¹å°æ¿€åŠ¨å‘¢^_^ã€‚




	    




